#####################################################################
# Toolchanger LED router (3× neopixel na každém toolheadu)
# Předpoklad: máš [neopixel SB_LEDS_T0], [neopixel SB_LEDS_T1] ... atd.
# Ošetřuje stav, kdy toolchanger nemá aktivní tool (tool_number = -1).
#####################################################################

[gcode_macro _TC_SET_SB_LEDS]
description: Pošle SET_LED na SB_LEDS_T{aktivní_tool} (fallback na T0)
gcode:
  {% set t = 0 %}

  # Pokud existuje toolchanger, zkus vzít aktivní tool_number
  {% if printer.toolchanger is defined %}
    {% set tn = printer.toolchanger.tool_number|default(0)|int %}
    # -1 = žádný aktivní tool -> fallback na T0
    {% if tn >= 0 %}
      {% set t = tn %}
    {% endif %}
  {% endif %}

  {% set led = "SB_LEDS_T%d" % t %}

  # Kdyby se někdy stalo, že LED objekt pro daný tool neexistuje, fallback na T0
  {% if printer[ "neopixel " + led ] is not defined %}
    {% set led = "SB_LEDS_T0" %}
  {% endif %}

  SET_LED LED={led} {rawparams}

#####################################################################
# Stavové LED makra pro 3 LED (bez animací)
#####################################################################

[gcode_macro SB_LED_OFF]
description: Vypne LEDky aktivního toolu
gcode:
  _TC_SET_SB_LEDS RED=0 GREEN=0 BLUE=0 WHITE=0 TRANSMIT=1

[gcode_macro SB_LED_IDLE]
description: Klidový stav (jemné světlo)
gcode:
  _TC_SET_SB_LEDS RED=0.02 GREEN=0.02 BLUE=0.02 WHITE=0 TRANSMIT=1

[gcode_macro SB_LED_HEATING]
description: Nahřívání
gcode:
  _TC_SET_SB_LEDS RED=0.20 GREEN=0.08 BLUE=0 WHITE=0 TRANSMIT=1

[gcode_macro SB_LED_PRINTING]
description: Tisk
gcode:
  _TC_SET_SB_LEDS RED=0 GREEN=0.15 BLUE=0.05 WHITE=0 TRANSMIT=1

[gcode_macro SB_LED_ERROR]
description: Chyba / pozornost
gcode:
  _TC_SET_SB_LEDS RED=0.25 GREEN=0 BLUE=0 WHITE=0 TRANSMIT=1


[gcode_macro STATUS_LEVELING]
gcode:
  # placeholder - zatím nic nedělá
  {% if printer["gcode_macro SB_LED_HEATING"] is defined %}
    SB_LED_HEATING
  {% endif %}

[gcode_macro STATUS_READY]
gcode:
  # placeholder - zatím nic nedělá
  {% if printer["gcode_macro SB_LED_IDLE"] is defined %}
    SB_LED_IDLE
  {% endif %}
